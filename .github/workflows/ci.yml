name: CI
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v2
        with:
          auto-update-conda: true
          environment-file: environment.yml
          activate-environment: rclass-project
          use-mamba: true
      - name: Install package
        run: pip install -e .
      - name: Run smoke test
        run: |
          python - << 'EOF'
          import numpy as np
          # Use Sage-based solver for CI to avoid Gurobi license issues
          from rclass.solver_sage import is_feasible_for_z_sage
          from rclass.bisection import solve_rational_approx_bisection
          # tiny sanity check
          X = np.random.rand(5,2)
          p_Phi = np.hstack([np.ones((5,1)), X])
          q_Phi = p_Phi
          f_c  = np.array([1,0,1,0,1])
          # pass the Sage solver explicitly
          solve_rational_approx_bisection(p_Phi, q_Phi, f_c,
                                          solver=is_feasible_for_z_sage,
                                          tolerance=1e-1)
          print("Smoke test passed")
      - name: Run unit tests
        run: pytest --maxfail=1 --disable-warnings -q